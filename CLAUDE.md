# 旧暦カレンダーアプリの開発ガイド

## 月齢計算と月相表示

### 月齢計算の方法

アプリでは以下の3つの月齢計算方法を実装しています：

1. **伝統的な旧暦日ベースの計算**
   - 旧暦の日付から直接計算: `月齢 = 旧暦日 - 1`
   - 旧暦1日が新月(0)、旧暦15日が満月(14)となる伝統的な計算
   - 日本の旧暦の考え方に最も近い

2. **簡易計算（旧来の実装）**
   - 計算式: `(Y - 2004)×10.88 + (M - 7)×0.97 + (D - 1) + 13.3`
   - 結果を30日周期内に収める
   - 旧暦日を入力すると、伝統的な月齢と近い値を返す

3. **天文学的計算**
   - 基準日（2000年1月6日 18:14 GMT）からの経過日数
   - 月の周期（29.53059日）で割った余りが月齢
   - 天文学的に正確な月齢を計算

4. **高精度計算**
   - NASA/JPL計算式に基づく
   - 月の楕円軌道などの補正項を含む
   - 最も天文学的に正確

### 月相と画像の対応

#### 月齢と月相名

```swift
// 月齢に対応する月の満ち欠けの名称
let moonName = ["新月", "", "繊月", "三日月", "", "", "", "上弦の月", "", "", "十日夜の月",         //0〜10
               "", "", "十三夜月", "小望月", "満月", "十六夜", "立待月", "居待月", "寝待月", "更待月", //11〜20
               "", "", "下弦の月", "", "", "有明月", "", "", "", "三十日月"]  //21〜30
```

- 空文字列（""）は、その月齢に特別な名称がないことを示す
- 月齢0: 新月、月齢7: 上弦の月、月齢15: 満月、月齢23: 下弦の月が主要な月相

#### 月齢と画像ファイル

画像ファイル名と月齢の対応：
- `moon0.png` または `moon0_90x90.png` → 新月（月齢0）
- `moon15.png` または `moon15_90x90.png` → 満月（月齢15）
- `moon30.png` または `moon30_90x90.png` → 新月前夜（月齢29.5〜30）

画像番号への変換ロジック：
```swift
// 月齢から画像番号への変換
let imageNumber = Int(floor(calculatedMoonAge))

// 範囲を0〜30に制限
let safeImageNumber = max(min(imageNumber, 30), 0)

// 画像を表示
self.moonImage.image = UIImage(named:"moon\(safeImageNumber)_90x90.png")
```

### 画面ごとの月齢表示方法

#### 一覧表示（ViewController）
- 旧暦モードでは、旧暦日から直接月齢を計算（伝統的な方法）
- 旧暦日に対応する月の画像を表示: `moon\(tagNumber).png`

#### 詳細画面（ScheduleViewController）
- 月齢計算結果をテキストで表示
- 計算された月齢に基づいて月相名を表示（空の場合は非表示）
- 月齢に対応する月画像を表示: `moon\(imageNumber)_90x90.png`

## 開発ガイドライン

### デバッグ時の推奨事項
- 月相名と月齢の整合性を確認
- 旧暦日と月齢の関係を確認（旧暦1日 = 月齢0、旧暦15日 = 月齢14）
- 月画像が月齢に合っているか確認

### テスト
旧暦カレンダーアプリの品質確保のため、以下のテストを推奨：

1. 旧暦日と月齢の対応テスト
   - 旧暦1日が月齢0（新月）になることを確認
   - 旧暦15日が月齢14（満月に近い）になることを確認

2. 月齢計算の精度テスト
   - 既知の新月・満月日で計算精度を検証
   - 例: 2025年5月5日（新月）、2025年5月20日（満月）

3. 画像表示の一貫性テスト
   - 同じ月齢なら一覧表示と詳細表示で同じ月の画像が表示されることを確認